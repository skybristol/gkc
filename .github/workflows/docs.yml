name: Docs

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry==1.8.5

      - name: Install docs dependencies
        run: poetry install --with docs --no-interaction

      - name: Build docs
        run: poetry run mkdocs build --strict

      - name: Deploy to datadistillery branch
        run: |
          # Save the site directory to a temp location
          SITE_BACKUP=$(mktemp -d)
          cp -r site/* "$SITE_BACKUP/"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Fetch datadistillery branch if it exists, otherwise create orphan
          if git rev-parse --verify origin/datadistillery >/dev/null 2>&1; then
            git fetch origin datadistillery
            git checkout datadistillery
            # Reset to remote state to avoid merge conflicts
            git reset --hard origin/datadistillery
          else
            git checkout --orphan datadistillery
          fi
          
          # Fetch again before push to update remote-tracking reference
          git fetch origin datadistillery
          
          # Remove all existing files except .git
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # Create site directory and copy the built site
          mkdir -p site
          cp -r "$SITE_BACKUP"/* site/
          
          # Commit and push if there are changes
          git add -A
          if ! git diff --cached --quiet; then
            COMMIT_MSG="Deploy docs from main build"
            git commit -m "$COMMIT_MSG"
            # Use --force-with-lease for safe force push on deployment branch
            git push --force-with-lease origin datadistillery
            echo "‚úÖ Deployed to datadistillery branch - site at /site/"
          else
            echo "üìù No changes to deploy"
          fi
